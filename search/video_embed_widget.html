<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Video Search Widget</title>
    <style>
      .video-search-widget {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        width: 100%;
        padding: 0;
        background: transparent;
      }

      .search-section {
        margin-bottom: 30px;
        padding: 0 10px;
      }

      .search-input {
        width: 100%;
        padding: 16px;
        border: 2px solid #e1e5e9;
        border-radius: 8px;
        font-size: 16px;
        margin-bottom: 15px;
        transition: border-color 0.2s;
        box-sizing: border-box;
      }

      .search-input:focus {
        outline: none;
        border-color: #0366d6;
        box-shadow: 0 0 0 3px rgba(3, 102, 214, 0.1);
      }

      .search-button {
        background: #0366d6;
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .search-button:hover {
        background: #0256cc;
        transform: translateY(-1px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
      }

      .search-button:disabled {
        background: #6c757d;
        cursor: not-allowed;
        transform: none;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .results-section {
        margin-top: 30px;
        padding: 0 10px;
      }

      .loading {
        text-align: center;
        color: #6c757d;
        font-style: italic;
      }

      .error {
        color: #d73a49;
        background: #ffeef0;
        padding: 12px;
        border-radius: 6px;
        border: 1px solid #f1c0c0;
      }

      .video-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
        gap: 24px;
        margin-top: 20px;
      }

      .video-item {
        border: 1px solid #e1e5e9;
        border-radius: 12px;
        overflow: hidden;
        background: #ffffff;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
        transition: transform 0.2s, box-shadow 0.2s;
      }

      .video-item:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.12);
      }

      .video-info {
        padding: 16px;
      }

      .video-title {
        font-weight: 600;
        margin-bottom: 10px;
        color: #24292e;
        font-size: 16px;
      }

      .video-prompt {
        font-size: 14px;
        color: #6c757d;
        line-height: 1.5;
        margin-bottom: 12px;
        display: -webkit-box;
        -webkit-line-clamp: 3;
        -webkit-box-orient: vertical;
        overflow: hidden;
      }

      .similarity-score {
        font-size: 13px;
        color: #28a745;
        font-weight: 600;
        background: #f0f9f0;
        padding: 4px 8px;
        border-radius: 6px;
        display: inline-block;
      }

      .no-results {
        text-align: center;
        color: #6c757d;
        font-style: italic;
        padding: 40px;
      }

      .play-button {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: none;
        border-radius: 50%;
        width: 60px;
        height: 60px;
        font-size: 24px;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.2s;
      }

      .play-button:hover {
        background: rgba(0, 0, 0, 0.9);
      }

      /* Ensure fullscreen works properly */
      .video-container video {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        object-fit: cover;
      }

      video:-webkit-full-screen {
        width: 100vw !important;
        height: 100vh !important;
        object-fit: contain !important;
      }

      video:-moz-full-screen {
        width: 100vw !important;
        height: 100vh !important;
        object-fit: contain !important;
      }

      video:fullscreen {
        width: 100vw !important;
        height: 100vh !important;
        object-fit: contain !important;
      }

      /* Ensure video container allows fullscreen */
      .video-container {
        position: relative;
        width: 100%;
        height: 0;
        padding-bottom: 58.33%; /* 672/1152 = 0.5833 = 58.33% */
        background: #000;
        overflow: hidden;
        border-radius: 12px 12px 0 0;
      }

      .fullscreen-btn {
        transition: background-color 0.2s;
      }

      .fullscreen-btn:hover {
        background: rgba(0, 0, 0, 0.9) !important;
      }

      /* Hide the native fullscreen button */
      video::-webkit-media-controls-fullscreen-button {
        display: none !important;
      }

      video::-moz-media-controls-fullscreen-button {
        display: none !important;
      }

      video::media-controls-fullscreen-button {
        display: none !important;
      }
    </style>
  </head>
  <body>
    <div class="video-search-widget" id="videoSearchWidget">
      <div class="search-section">
        <h3 style="margin-top: 0; color: #24292e">Search for Videos</h3>
        <input
          type="text"
          class="search-input"
          id="searchInput"
          placeholder="Describe the type of video you're looking for..."
        />
        <button
          class="search-button"
          id="searchButton"
          onclick="performSearch()"
        >
          Search Videos
        </button>
      </div>

      <div class="results-section" id="resultsSection" style="display: none">
        <div id="resultsContainer"></div>
      </div>
    </div>

    <script>
      // Configuration - these will be replaced by the server
      const CONFIG = {
        apiUrl: "{{API_URL}}",
        defaultTopN: "{{DEFAULT_TOP_N}}",
        githubRepo: "{{GITHUB_REPO}}",
        branch: "{{BRANCH}}",
        showControls: "{{SHOW_CONTROLS}}",
      };

      let currentVideos = [];

      // Handle Enter key in search input
      document
        .getElementById("searchInput")
        .addEventListener("keypress", function (e) {
          if (e.key === "Enter") {
            performSearch();
          }
        });

      async function performSearch() {
        const query = document.getElementById("searchInput").value.trim();
        const searchButton = document.getElementById("searchButton");
        const resultsSection = document.getElementById("resultsSection");
        const resultsContainer = document.getElementById("resultsContainer");

        if (!query) {
          alert("Please enter a search query");
          return;
        }

        // Show loading state
        searchButton.disabled = true;
        searchButton.textContent = "Searching...";
        resultsSection.style.display = "block";
        resultsContainer.innerHTML =
          '<div class="loading">Searching for matching videos...</div>';

        try {
          // Build API URL
          const apiUrl = `${CONFIG.apiUrl}/search?query=${encodeURIComponent(
            query
          )}&top_n=${CONFIG.defaultTopN}&github_repo=${
            CONFIG.githubRepo
          }&branch=${CONFIG.branch}`;

          // Fetch results
          const response = await fetch(apiUrl);

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json();

          if (data.error) {
            throw new Error(data.error);
          }

          currentVideos = data.results || [];
          displayResults(currentVideos);
        } catch (error) {
          console.error("Search error:", error);
          resultsContainer.innerHTML = `
                  <div class="error">
                      <strong>Search failed:</strong> ${error.message}
                      <br><small>Please try again or check your connection.</small>
                  </div>
              `;
        } finally {
          // Reset button state
          searchButton.disabled = false;
          searchButton.textContent = "Search Videos";
        }
      }

      function displayResults(videos) {
        const resultsContainer = document.getElementById("resultsContainer");

        if (!videos || videos.length === 0) {
          resultsContainer.innerHTML =
            '<div class="no-results">No videos found for your search.</div>';
          return;
        }

        const videosHtml = videos
          .map(
            (video, index) => `
               <div class="video-item">
                   <div class="video-container" ${
                     CONFIG.showControls
                       ? ""
                       : 'onclick="togglePlayPause(this)"'
                   }>
                         <video
                             id="video-${index}"
                             preload="metadata"
                             ${
                               CONFIG.showControls
                                 ? 'controls controlsList="nodownload nofullscreen" allowfullscreen webkit-playsinline playsinline'
                                 : ""
                             }
                             ${
                               CONFIG.showControls
                                 ? ""
                                 : 'onclick="event.stopPropagation()"'
                             }
                             onloadedmetadata="setupVideoEvents(this)"
                             oncanplay="enableFullscreen(this)"
                         >
                           <source src="${video.video_url}" type="video/mp4">
                           Your browser does not support the video tag.
                       </video>
                       ${
                         CONFIG.showControls
                           ? ""
                           : `<button class="play-button" id="play-button-${index}">▶</button>`
                       }
                   </div>
                   <div class="video-info">
                       <div class="video-title">Video ${video.rank}</div>
                       <div class="video-prompt">${video.video_prompt}</div>
                       <div class="similarity-score">Match: ${(
                         video.similarity_score * 100
                       ).toFixed(2)}%</div>
                   </div>
               </div>
           `
          )
          .join("");

        resultsContainer.innerHTML = `
              <h4 style="margin-bottom: 15px; color: #24292e;">
                  Found ${videos.length} matching video${
          videos.length === 1 ? "" : "s"
        }
              </h4>
              <div class="video-grid">${videosHtml}</div>
          `;
      }

      function setupVideoEvents(video) {
        const videoIndex = video.id.split("-")[1];
        const playButton = document.getElementById(`play-button-${videoIndex}`);

        // Only setup custom play button events if controls are disabled
        if (!CONFIG.showControls && playButton) {
          video.addEventListener("play", function () {
            playButton.style.display = "none";
          });

          video.addEventListener("pause", function () {
            playButton.style.display = "flex";
          });

          video.addEventListener("ended", function () {
            playButton.style.display = "flex";
          });
        }
      }

      function enableFullscreen(video) {
        console.log("enableFullscreen called for video:", video);
        console.log("CONFIG.showControls:", CONFIG.showControls);
        console.log("video.requestFullscreen:", video.requestFullscreen);

        // Add fullscreen support programmatically
        if (CONFIG.showControls && video.requestFullscreen) {
          // Create a fullscreen button if it doesn't exist
          const container = video.closest(".video-container");
          if (!container.querySelector(".fullscreen-btn")) {
            const fullscreenBtn = document.createElement("button");
            fullscreenBtn.className = "fullscreen-btn";
            fullscreenBtn.innerHTML = "⛶";
            fullscreenBtn.style.cssText = `
               position: absolute;
               top: 10px;
               right: 10px;
               background: rgba(0,0,0,0.7);
               color: white;
               border: none;
               border-radius: 4px;
               padding: 8px;
               cursor: pointer;
               font-size: 16px;
               z-index: 10;
               display: flex;
               align-items: center;
               justify-content: center;
             `;

            fullscreenBtn.addEventListener("click", function (e) {
              e.stopPropagation();
              console.log("Fullscreen button clicked");

              // Try multiple fullscreen methods for cross-browser compatibility
              const fullscreenMethods = [
                () => video.requestFullscreen(),
                () => video.webkitRequestFullscreen(),
                () => video.mozRequestFullScreen(),
                () => video.msRequestFullscreen(),
              ];

              let fullscreenAttempted = false;

              for (const method of fullscreenMethods) {
                if (method) {
                  try {
                    const result = method();
                    if (result && result.then) {
                      result
                        .then(() => {
                          console.log("Successfully entered fullscreen");
                          fullscreenAttempted = true;
                        })
                        .catch((err) => {
                          console.log("Fullscreen method failed:", err);
                          if (!fullscreenAttempted) {
                            tryFallbackFullscreen(video);
                          }
                        });
                      return;
                    }
                  } catch (err) {
                    console.log("Fullscreen method error:", err);
                  }
                }
              }

              // If all methods failed, try fallback
              if (!fullscreenAttempted) {
                tryFallbackFullscreen(video);
              }
            });

            container.appendChild(fullscreenBtn);
          }
        }
      }

      function tryFallbackFullscreen(video) {
        console.log("Trying fallback fullscreen method");

        // Store original container and position
        const originalContainer = video.parentElement;
        const originalIndex = Array.from(originalContainer.children).indexOf(
          video
        );
        const wasPlaying = !video.paused;

        // Create a modal overlay for "fullscreen-like" experience
        const overlay = document.createElement("div");
        overlay.style.cssText = `
           position: fixed;
           top: 0;
           left: 0;
           width: 100vw;
           height: 100vh;
           background: black;
           z-index: 9999;
           display: flex;
           align-items: center;
           justify-content: center;
           cursor: pointer;
         `;

        // Create a close button
        const closeBtn = document.createElement("button");
        closeBtn.innerHTML = "✕";
        closeBtn.style.cssText = `
           position: absolute;
           top: 20px;
           right: 20px;
           background: rgba(255,255,255,0.8);
           border: none;
           border-radius: 50%;
           width: 40px;
           height: 40px;
           font-size: 20px;
           cursor: pointer;
           z-index: 10000;
         `;

        // Move the original video to the overlay (no cloning needed)
        video.style.cssText = `
           max-width: 100vw;
           max-height: 100vh;
           width: auto;
           height: auto;
         `;
        video.controls = true;

        // Add elements to overlay
        overlay.appendChild(video);
        overlay.appendChild(closeBtn);
        document.body.appendChild(overlay);

        // Auto-play the video if it was playing
        if (wasPlaying) {
          video.play().catch((err) => console.log("Auto-play failed:", err));
        }

        // Function to close fullscreen and restore original position
        function closeFullscreen() {
          // Store current playback state
          const isPlaying = !video.paused;

          // Restore original video styling
          video.style.cssText = `
             width: 100%;
             height: 100%;
             object-fit: cover;
           `;

          // Move video back to original container
          originalContainer.insertBefore(
            video,
            originalContainer.children[originalIndex]
          );

          // Remove overlay
          document.body.removeChild(overlay);

          // Resume playing if it was playing
          if (isPlaying) {
            video
              .play()
              .catch((err) => console.log("Resume play failed:", err));
          }
        }

        // Close overlay when clicking outside or on close button
        overlay.addEventListener("click", function (e) {
          if (e.target === overlay || e.target === closeBtn) {
            closeFullscreen();
          }
        });

        // Close with Escape key
        const handleKeyPress = function (e) {
          if (e.key === "Escape") {
            closeFullscreen();
            document.removeEventListener("keydown", handleKeyPress);
          }
        };
        document.addEventListener("keydown", handleKeyPress);
      }

      function togglePlayPause(container) {
        // Only handle custom play/pause if controls are disabled
        if (CONFIG.showControls) {
          return;
        }

        const video = container.querySelector("video");
        const playButton = container.querySelector(".play-button");

        if (video.paused) {
          // Pause all other videos first
          document.querySelectorAll("video").forEach((v) => {
            if (v !== video && !v.paused) {
              v.pause();
            }
          });

          video.play().catch((error) => {
            console.error("Error playing video:", error);
            alert(
              "Error playing video. The video file might not be accessible."
            );
          });
        } else {
          video.pause();
        }
      }

      // No auto-search on load - user starts with clean search box
    </script>
  </body>
</html>
